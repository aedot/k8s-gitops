# yaml-language-server: $schema=https://raw.githubusercontent.com/budimanjojo/talhelper/master/pkg/config/schemas/talconfig.json
---
clusterName: k8s-gitops

talosVersion: "${talosVersion}"
kubernetesVersion: "${kubernetesVersion}"

endpoint: https://10.0.20.10:6443
additionalApiServerCertSans: &sans
  - "127.0.0.1"
  - &talosControlplaneVip "10.0.20.10"
additionalMachineCertSans: *sans

clusterPodNets: ["10.42.0.0/16"]
clusterSvcNets: ["10.43.0.0/16"]

# Disable built-in CNI to use Cilium
cniConfig:
  name: none

nodes:
  - hostname: "oya"
    ipAddress: "10.0.20.11"
    installDiskSelector:
      model: "SPCC M.2 PCIe SSD"
    machineSpec:
      secureboot: false
    talosImageURL: factory.talos.dev/installer/4996bded29de59048af8f58325ccfe1a1b6461ff098c669f87eef8f3e6b7239b
    controlPlane: true
    userVolumes:
      - name: longhorn
        provisioning:
          diskSelector:
            match: disk.model == "KINGSTON OM8PGP41024N-A0"
          minSize: "500GiB"
    networkInterfaces:
      - interface: bond0
        bond:
          deviceSelectors:
            - hardwareAddr: "58:47:ca:7b:e6:e5"
              driver: igc
          mode: active-backup
        dhcp: true
        vip:
          ip: *talosControlplaneVip
        vlans: &vlans
          - # IoT VLAN
            { vlanId: 101, dhcp: false, mtu: 1500 }
            
  - hostname: "aje"
    ipAddress: "10.0.20.12"
    installDiskSelector:
      model: "Netac NVMe SSD 1TB"
    machineSpec:
      secureboot: false
    talosImageURL: factory.talos.dev/installer/4996bded29de59048af8f58325ccfe1a1b6461ff098c669f87eef8f3e6b7239b
    controlPlane: true
    userVolumes:
      - name: longhorn
        provisioning:
          diskSelector:
            match: disk.model == "KINGSTON OM8PGP41024N-A0"
          minSize: "500GiB"
    networkInterfaces:
      - interface: bond0
        bond:
          deviceSelectors:
            - hardwareAddr: "58:47:ca:7b:e9:49"
              driver: igc
          mode: active-backup
        dhcp: true
        vip:
          ip: *talosControlplaneVip
        vlans: *vlans

  - hostname: "oba"
    ipAddress: "10.0.20.13"
    installDiskSelector:
      model: "SPCC M.2 PCIe SSD"
    machineSpec:
      secureboot: false
    talosImageURL: factory.talos.dev/installer/4996bded29de59048af8f58325ccfe1a1b6461ff098c669f87eef8f3e6b7239b
    controlPlane: true
    userVolumes:
      - name: longhorn
        provisioning:
          diskSelector:
            match: disk.model == "KINGSTON OM8PGP41024N-A0"
          minSize: "500GiB"
    networkInterfaces:
      - interface: bond0
        bond:
          deviceSelectors:
            - hardwareAddr: "58:47:ca:7b:ea:1d"
              driver: igc
          mode: active-backup
        dhcp: true
        vip:
          ip: *talosControlplaneVip
        vlans: *vlans

# Controller patches
controlPlane:
  nodeLabels:
    intel.feature.node.kubernetes.io/gpu: "true"
    topology.kubernetes.io/region: main

  # schematic:
  #   customization:
  #     extraKernelArgs:
  #       - -init_on_alloc # Less security, faster puter
  #       - -init_on_free # Less security, faster puter
  #       - -selinux # Less security, faster puter
  #       - apparmor=0 # Less security, faster puter
  #       - i915.enable_guc=3 # Meteor Lake CPU / iGPU
  #       - init_on_alloc=0 # Less security, faster puter
  #       - init_on_free=0 # Less security, faster puter
  #       - intel_iommu=on # PCI Passthrough
  #       - iommu=pt # PCI Passthrough
  #       - mitigations=off # Less security, faster puter
  #       - module_blacklist=igc # Disable onboard NIC
  #       - security=none # Less security, faster puter
  #       - sysctl.kernel.kexec_load_disabled=1 # Meteor Lake CPU / iGPU
  #       - talos.auditd.disabled=1 # Less security, faster puter
  #     systemExtensions:
  #       officialExtensions:
  #         - siderolabs/gasket-driver
  #         - siderolabs/i915
  #         - siderolabs/intel-ucode
  #         - siderolabs/iscsi-tools
  #         - siderolabs/mei
  #         - siderolabs/thunderbolt
  #         - siderolabs/util-linux-tools

  patches:
    # Controller patches
      - "@./patches/controller/admission-controller-patch.yaml"
      - "@./patches/controller/cluster.yaml"
    # Global patches
      - "@./patches/global/machine-features.yaml"
      - "@./patches/global/machine-files.yaml"
      - "@./patches/global/machine-install.yaml"
      - "@./patches/global/machine-kubelet.yaml"
      - "@./patches/global/machine-network.yaml"
      - "@./patches/global/machine-sysctls.yaml"
      - "@./patches/global/machine-time.yaml"
      - "@./patches/global/machine-udev.yaml"
